static const u_char *
zmtp1_print_frame(netdissect_options *ndo, const u_char *cp, const u_char *ep)
{
	uint64_t body_len_declared, body_len_captured, header_len;
	uint8_t flags;

	ND_PRINT((ndo, "\n\t"));
	ND_TCHECK2(*cp, 1); /* length/0xFF */

	if (cp[0] != 0xFF) {
		header_len = 1; /* length */
		body_len_declared = cp[0];
		ND_PRINT((ndo, " frame flags+body  (8-bit) length %" PRIu64, body_len_declared));
	} else {
		header_len = 1 + 8; /* 0xFF, length */
		ND_PRINT((ndo, " frame flags+body (64-bit) length"));
		ND_TCHECK2(*cp, header_len); /* 0xFF, length */
		body_len_declared = EXTRACT_BE_64BITS(cp + 1);
		ND_PRINT((ndo, " %" PRIu64, body_len_declared));
	}
	if (body_len_declared == 0)
		return cp + header_len; /* skip to the next frame */
	ND_TCHECK2(*cp, header_len + 1); /* ..., flags */
	flags = cp[header_len];

	body_len_captured = ep - cp - header_len;
	if (body_len_declared > body_len_captured)
		ND_PRINT((ndo, " (%" PRIu64 " captured)", body_len_captured));
	ND_PRINT((ndo, ", flags 0x%02x", flags));

	if (ndo->ndo_vflag) {
		uint64_t body_len_printed = min(body_len_captured, body_len_declared);

		ND_PRINT((ndo, " (%s|%s|%s|%s|%s|%s|%s|%s)",
			flags & 0x80 ? "MBZ" : "-",
			flags & 0x40 ? "MBZ" : "-",
			flags & 0x20 ? "MBZ" : "-",
			flags & 0x10 ? "MBZ" : "-",
			flags & 0x08 ? "MBZ" : "-",
			flags & 0x04 ? "MBZ" : "-",
			flags & 0x02 ? "MBZ" : "-",
			flags & 0x01 ? "MORE" : "-"));

		if (ndo->ndo_vflag == 1)
			body_len_printed = min(VBYTES + 1, body_len_printed);
		if (body_len_printed > 1) {
			ND_PRINT((ndo, ", first %" PRIu64 " byte(s) of body:", body_len_printed - 1));
			hex_and_ascii_print(ndo, "\n\t ", cp + header_len + 1, body_len_printed - 1);
			ND_PRINT((ndo, "\n"));
		}
	}

	/*
	 * Do not advance cp by the sum of header_len and body_len_declared
	 * before each offset has successfully passed ND_TCHECK2() as the
	 * sum can roll over (9 + 0xfffffffffffffff7 = 0) and cause an
	 * infinite loop.
	 */
	cp += header_len;
	ND_TCHECK2(*cp, body_len_declared); /* Next frame within the buffer ? */
	return cp + body_len_declared;

trunc:
	ND_PRINT((ndo, "%s", tstr));
	return ep;
}
