--- esp_reg_write_OLD.c	2021-12-06 23:59:08.696276400 +0800
+++ esp_reg_write_NEW.c	2021-12-06 23:59:08.697271400 +0800
@@ -11,7 +11,11 @@
         break;
     case ESP_FIFO:
         if (s->do_cmd) {
-            s->cmdbuf[s->cmdlen++] = val & 0xff;
+            if (s->cmdlen < TI_BUFSZ) {
+                s->cmdbuf[s->cmdlen++] = val & 0xff;
+            } else {
+                trace_esp_error_fifo_overrun();
+            }
         } else if (s->ti_size == TI_BUFSZ - 1) {
             trace_esp_error_fifo_overrun();
         } else {
