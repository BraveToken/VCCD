--- kvm_arch_vcpu_ioctl_set_sregs_OLD.c	2021-12-06 23:31:58.084469900 +0800
+++ kvm_arch_vcpu_ioctl_set_sregs_NEW.c	2021-12-06 23:31:58.084469900 +0800
@@ -5,6 +5,9 @@
 	int pending_vec, max_bits, idx;
 	struct desc_ptr dt;
 
+	if (!guest_cpuid_has_xsave(vcpu) && (sregs->cr4 & X86_CR4_OSXSAVE))
+		return -EINVAL;
+
 	dt.size = sregs->idt.limit;
 	dt.address = sregs->idt.base;
 	kvm_x86_ops->set_idt(vcpu, &dt);
