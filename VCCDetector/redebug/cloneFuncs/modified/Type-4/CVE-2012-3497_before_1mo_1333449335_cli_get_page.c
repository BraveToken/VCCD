static inline void *cli_get_page(tmem_cli_mfn_t cmfn, unsigned long *pcli_mfn,
                                 pfp_t **pcli_pfp, bool_t cli_write)
{
    unsigned long cli_mfn;
    p2m_type_t t;
    struct page_info *page;
    int ret;

    cli_mfn = mfn_x(get_gfn(current->domain, cmfn, &t));
    if ( t != p2m_ram_rw || !mfn_valid(cli_mfn) )
    {
            put_gfn(current->domain, (unsigned long) cmfn);
            return NULL;
    }
    page = mfn_to_page(cli_mfn);
    if ( cli_write )
        ret = get_page_and_type(page, current->domain, PGT_writable_page);
    else
        ret = get_page(page, current->domain);
    if ( !ret )
    {
        put_gfn(current->domain, (unsigned long) cmfn);
        return NULL;
    }
    *pcli_mfn = cli_mfn;
    *pcli_pfp = (pfp_t *)page;
    return map_domain_page(cli_mfn);
}
