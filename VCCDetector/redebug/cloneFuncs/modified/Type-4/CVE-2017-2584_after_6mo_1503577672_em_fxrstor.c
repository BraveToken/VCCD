static int em_fxrstor(struct x86_emulate_ctxt *ctxt)
{
	struct fxregs_state fx_state;
	int rc;
	size_t size;

	rc = check_fxsr(ctxt);
	if (rc != X86EMUL_CONTINUE)
		return rc;

	ctxt->ops->get_fpu(ctxt);

	size = fxstate_size(ctxt);
	if (size < __fxstate_size(16)) {
		rc = asm_safe("fxsave %[fx]", , [fx] "+m"(fx_state));
		if (rc != X86EMUL_CONTINUE)
			goto out;
	}

	rc = segmented_read_std(ctxt, ctxt->memop.addr.mem, &fx_state, size);
	if (rc != X86EMUL_CONTINUE)
		goto out;

	if (fx_state.mxcsr >> 16) {
		rc = emulate_gp(ctxt, 0);
		goto out;
	}

	if (rc == X86EMUL_CONTINUE)
		rc = asm_safe("fxrstor %[fx]", : [fx] "m"(fx_state));

out:
	ctxt->ops->put_fpu(ctxt);

	return rc;
}
