--- vgic_distr_mmio_write_OLD.c	2021-12-07 00:11:58.891312500 +0800
+++ vgic_distr_mmio_write_NEW.c	2021-12-07 00:11:58.891312500 +0800
@@ -119,8 +119,8 @@
     case GICD_ICFGR + 2 ... GICD_ICFGRN: /* SPIs */
         if ( dabt.size != 2 ) goto bad_width;
         rank = vgic_irq_rank(v, 2, gicd_reg - GICD_ICFGR);
-        vgic_lock_rank(v, rank);
         if ( rank == NULL) goto write_ignore;
+        vgic_lock_rank(v, rank);
         rank->icfg[REG_RANK_INDEX(2, gicd_reg - GICD_ICFGR)] = *r;
         vgic_unlock_rank(v, rank);
         return 1;
