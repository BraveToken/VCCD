--- get_free_port_OLD.c	2021-12-07 00:10:26.337861500 +0800
+++ get_free_port_NEW.c	2021-12-07 00:10:26.338858100 +0800
@@ -17,7 +17,6 @@
     chn = xzalloc_array(struct evtchn, EVTCHNS_PER_BUCKET);
     if ( unlikely(chn == NULL) )
         return -ENOMEM;
-    bucket_from_port(d, port) = chn;
 
     for ( i = 0; i < EVTCHNS_PER_BUCKET; i++ )
     {
@@ -30,5 +29,7 @@
         }
     }
 
+    bucket_from_port(d, port) = chn;
+
     return port;
 }
