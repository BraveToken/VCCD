static s16
__gnttab_swap_grant_ref(grant_ref_t ref_a, grant_ref_t ref_b)
{
    struct domain *d;
    struct active_grant_entry *act;
    s16 rc = GNTST_okay;

    d = rcu_lock_current_domain();

    spin_lock(&d->grant_table->lock);

    act = &active_entry(d->grant_table, ref_a);
    if ( act->pin )
        PIN_FAIL(out, GNTST_eagain, "ref a %ld busy\n", (long)ref_a);

    act = &active_entry(d->grant_table, ref_b);
    if ( act->pin )
        PIN_FAIL(out, GNTST_eagain, "ref b %ld busy\n", (long)ref_b);

    if ( d->grant_table->gt_version == 1 )
    {
        grant_entry_v1_t shared;

        shared = shared_entry_v1(d->grant_table, ref_a);

        shared_entry_v1(d->grant_table, ref_a) =
            shared_entry_v1(d->grant_table, ref_b);

        shared_entry_v1(d->grant_table, ref_b) = shared;
    }
    else
    {
        grant_entry_v2_t shared;
        grant_status_t status;

        shared = shared_entry_v2(d->grant_table, ref_a);
        status = status_entry(d->grant_table, ref_a);

        shared_entry_v2(d->grant_table, ref_a) =
            shared_entry_v2(d->grant_table, ref_b);
        status_entry(d->grant_table, ref_a) =
            status_entry(d->grant_table, ref_b);

        shared_entry_v2(d->grant_table, ref_b) = shared;
        status_entry(d->grant_table, ref_b) = status;
    }

out:
    spin_unlock(&d->grant_table->lock);

    rcu_unlock_domain(d);

    return rc;
}
