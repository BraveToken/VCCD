--- _write_trylock_OLD.c	2021-12-07 00:12:54.679103900 +0800
+++ _write_trylock_NEW.c	2021-12-07 00:12:54.679103900 +0800
@@ -1,8 +1,12 @@
 int _write_trylock(rwlock_t *lock)
 {
+    uint32_t x;
+
     check_lock(&lock->debug);
-    if ( !_raw_write_trylock(&lock->raw) )
-        return 0;
+    do {
+        if ( (x = lock->lock) != 0 )
+            return 0;
+    } while ( cmpxchg(&lock->lock, x, x|RW_WRITE_FLAG) != x );
     preempt_disable();
     return 1;
 }
