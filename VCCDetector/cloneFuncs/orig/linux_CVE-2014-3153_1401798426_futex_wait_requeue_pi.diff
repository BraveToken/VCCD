--- futex_wait_requeue_pi_OLD.c	2021-12-06 23:34:56.564108800 +0800
+++ futex_wait_requeue_pi_NEW.c	2021-12-06 23:34:56.564108800 +0800
@@ -51,6 +51,15 @@
 	if (ret)
 		goto out_key2;
 
+	/*
+	 * The check above which compares uaddrs is not sufficient for
+	 * shared futexes. We need to compare the keys:
+	 */
+	if (match_futex(&q.key, &key2)) {
+		ret = -EINVAL;
+		goto out_put_keys;
+	}
+
 	/* Queue the futex_q, drop the hb lock, wait for wakeup. */
 	futex_wait_queue_me(hb, &q, to);
 
