--- guest_physmap_add_entry_OLD.c	2021-12-07 00:09:08.961785700 +0800
+++ guest_physmap_add_entry_NEW.c	2021-12-07 00:09:08.961785700 +0800
@@ -125,7 +125,10 @@
     if ( mfn_valid(_mfn(mfn)) ) 
     {
         if ( !set_p2m_entry(p2m, gfn, _mfn(mfn), page_order, t, p2m->default_access) )
+        {
             rc = -EINVAL;
+            goto out; /* Failed to update p2m, bail without updating m2p. */
+        }
         if ( !p2m_is_grant(t) )
         {
             for ( i = 0; i < (1UL << page_order); i++ )
@@ -148,6 +151,7 @@
         }
     }
 
+out:
     p2m_unlock(p2m);
 
     return rc;
