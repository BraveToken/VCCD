--- rds_sendmsg_OLD.c	2021-12-06 23:36:37.117170300 +0800
+++ rds_sendmsg_NEW.c	2021-12-06 23:36:37.118169200 +0800
@@ -35,11 +35,13 @@
 		release_sock(sk);
 	}
 
-	/* racing with another thread binding seems ok here */
+	lock_sock(sk);
 	if (daddr == 0 || rs->rs_bound_addr == 0) {
+		release_sock(sk);
 		ret = -ENOTCONN; /* XXX not a great errno */
 		goto out;
 	}
+	release_sock(sk);
 
 	if (payload_len > rds_sk_sndbuf(rs)) {
 		ret = -EMSGSIZE;
