EXPORT int tmh_copy_from_client(pfp_t *pfp,
    tmem_cli_mfn_t cmfn, pagesize_t tmem_offset,
    pagesize_t pfn_offset, pagesize_t len, tmem_cli_va_t clibuf)
{
    unsigned long tmem_mfn, cli_mfn = 0;
    char *tmem_va, *cli_va = NULL;
    pfp_t *cli_pfp = NULL;
    int rc = 1;

    if ( tmem_offset > PAGE_SIZE || pfn_offset > PAGE_SIZE || len > PAGE_SIZE )
        return -EINVAL;
    ASSERT(pfp != NULL);
    tmem_mfn = page_to_mfn(pfp);
    tmem_va = map_domain_page(tmem_mfn);
    if ( tmem_offset == 0 && pfn_offset == 0 && len == 0 )
    {
        memset(tmem_va, 0, PAGE_SIZE);
        unmap_domain_page(tmem_va);
        return 1;
    }
    if ( guest_handle_is_null(clibuf) )
    {
        cli_va = cli_get_page(cmfn, &cli_mfn, &cli_pfp, 0);
        if ( cli_va == NULL )
        {
            unmap_domain_page(tmem_va);
            return -EFAULT;
        }
    }
    mb();
    if ( len == PAGE_SIZE && !tmem_offset && !pfn_offset && cli_va )
        tmh_copy_page(tmem_va, cli_va);
    else if ( (tmem_offset+len <= PAGE_SIZE) &&
              (pfn_offset+len <= PAGE_SIZE) )
    {
        if ( cli_va )
            memcpy(tmem_va + tmem_offset, cli_va + pfn_offset, len);
        else if ( copy_from_guest_offset(tmem_va + tmem_offset, clibuf,
                                         pfn_offset, len) )
            rc = -EFAULT;
    }
    else if ( len )
        rc = -EINVAL;
    if ( cli_va )
        cli_put_page(cmfn, cli_va, cli_pfp, cli_mfn, 0);
    unmap_domain_page(tmem_va);
    return rc;
}
