--- kvm_irq_delivery_to_apic_fast_OLD.c	2021-12-06 23:34:14.037850300 +0800
+++ kvm_irq_delivery_to_apic_fast_NEW.c	2021-12-06 23:34:14.037850300 +0800
@@ -35,8 +35,12 @@
 		dst = &map->phys_map[irq->dest_id];
 	} else {
 		u32 mda = irq->dest_id << (32 - map->ldr_bits);
+		u16 cid = apic_cluster_id(map, mda);
 
-		dst = map->logical_map[apic_cluster_id(map, mda)];
+		if (cid >= ARRAY_SIZE(map->logical_map))
+			goto out;
+
+		dst = map->logical_map[cid];
 
 		bitmap = apic_logical_id(map, mda);
 
