--- tpm_common_write_OLD.c	2021-12-06 23:31:16.263323500 +0800
+++ tpm_common_write_NEW.c	2021-12-06 23:31:16.264320200 +0800
@@ -23,6 +23,12 @@
 		return -EFAULT;
 	}
 
+	if (in_size < 6 ||
+	    in_size < be32_to_cpu(*((__be32 *) (priv->data_buffer + 2)))) {
+		mutex_unlock(&priv->buffer_mutex);
+		return -EINVAL;
+	}
+
 	/* atomic tpm command send and result receive. We only hold the ops
 	 * lock during this period so that the tpm can be unregistered even if
 	 * the char dev is held open.
