--- virtqueue_pop_OLD.c	2021-12-06 23:59:26.525587800 +0800
+++ virtqueue_pop_NEW.c	2021-12-06 23:59:26.525587800 +0800
@@ -21,6 +21,11 @@
 
     max = vq->vring.num;
 
+    if (vq->inuse >= vq->vring.num) {
+        error_report("Virtqueue size exceeded");
+        exit(1);
+    }
+
     i = head = virtqueue_get_head(vq, vq->last_avail_idx++);
     if (virtio_vdev_has_feature(vdev, VIRTIO_RING_F_EVENT_IDX)) {
         vring_set_avail_event(vq, vq->last_avail_idx);
