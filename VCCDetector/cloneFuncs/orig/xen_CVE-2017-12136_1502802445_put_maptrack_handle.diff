--- put_maptrack_handle_OLD.c	2021-12-07 00:16:04.768672100 +0800
+++ put_maptrack_handle_NEW.c	2021-12-07 00:16:04.769669600 +0800
@@ -12,6 +12,8 @@
     /* 2. Add entry to the tail of the list on the original VCPU. */
     v = currd->vcpu[maptrack_entry(t, handle).vcpu];
 
+    spin_lock(&v->maptrack_freelist_lock);
+
     cur_tail = read_atomic(&v->maptrack_tail);
     do {
         prev_tail = cur_tail;
@@ -20,4 +22,6 @@
 
     /* 3. Update the old tail entry to point to the new entry. */
     write_atomic(&maptrack_entry(t, prev_tail).ref, handle);
+
+    spin_unlock(&v->maptrack_freelist_lock);
 }
