--- vfio_dma_do_map_OLD.c	2021-12-06 23:45:09.079880300 +0800
+++ vfio_dma_do_map_NEW.c	2021-12-06 23:45:09.079880300 +0800
@@ -36,12 +36,18 @@
 		goto out_unlock;
 	}
 
+	if (!iommu->dma_avail) {
+		ret = -ENOSPC;
+		goto out_unlock;
+	}
+
 	dma = kzalloc(sizeof(*dma), GFP_KERNEL);
 	if (!dma) {
 		ret = -ENOMEM;
 		goto out_unlock;
 	}
 
+	iommu->dma_avail--;
 	dma->iova = iova;
 	dma->vaddr = vaddr;
 	dma->prot = prot;
