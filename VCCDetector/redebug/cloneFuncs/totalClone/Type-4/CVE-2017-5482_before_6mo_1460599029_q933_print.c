void
q933_print(netdissect_options *ndo,
           const u_char *p, u_int length)
{
	const u_char *ptemp = p;
	const struct ie_tlv_header_t  *ie_p;
        int olen;
	int is_ansi = 0;
        u_int codeset;
        u_int ie_is_known = 0;

	if (length < 9)	/* shortest: Q.933a LINK VERIFY */
		goto trunc;

	ND_TCHECK2(*p, 3);
        codeset = p[2]&0x0f;   /* extract the codeset */

	if (p[2] == MSG_ANSI_LOCKING_SHIFT) {
	        is_ansi = 1;
	}

        ND_PRINT((ndo, "%s", ndo->ndo_eflag ? "" : "Q.933, "));

	/* printing out header part */
	ND_PRINT((ndo, "%s, codeset %u", is_ansi ? "ANSI" : "CCITT", codeset));

	if (p[0]) {
	        ND_PRINT((ndo, ", Call Ref: 0x%02x", p[0]));
	}
        if (ndo->ndo_vflag) {
                ND_PRINT((ndo, ", %s (0x%02x), length %u",
		       tok2str(fr_q933_msg_values,
			       "unknown message", p[1]),
		       p[1],
		       length));
        } else {
                ND_PRINT((ndo, ", %s",
		       tok2str(fr_q933_msg_values,
			       "unknown message 0x%02x", p[1])));
	}

        olen = length; /* preserve the original length for non verbose mode */

	if (length < (u_int)(2 - is_ansi)) {
		ND_PRINT((ndo, "[|q.933]"));
		return;
	}
	length -= 2 + is_ansi;
	ptemp += 2 + is_ansi;

	/* Loop through the rest of IE */
	while (length > sizeof(struct ie_tlv_header_t)) {
		ie_p = (const struct ie_tlv_header_t  *)ptemp;
		if (length < sizeof(struct ie_tlv_header_t) ||
		    length < sizeof(struct ie_tlv_header_t) + ie_p->ie_len) {
                    if (ndo->ndo_vflag) { /* not bark if there is just a trailer */
                        ND_PRINT((ndo, "\n[|q.933]"));
                    } else {
                        ND_PRINT((ndo, ", length %u", olen));
		    }
                    return;
		}
		if (!ND_TTEST(*ie_p)) {
			if (ndo->ndo_vflag)
				ND_PRINT((ndo, "\n"));
			ND_PRINT((ndo, "\n[|q.933]"));
			return;
		}

                /* lets do the full IE parsing only in verbose mode
                 * however some IEs (DLCI Status, Link Verify)
                 * are also interestting in non-verbose mode */
                if (ndo->ndo_vflag) {
                    ND_PRINT((ndo, "\n\t%s IE (0x%02x), length %u: ",
                           tok2str(fr_q933_ie_codesets[codeset],
				   "unknown", ie_p->ie_type),
                           ie_p->ie_type,
                           ie_p->ie_len));
		}

                /* sanity checks */
                if (ie_p->ie_type == 0 || ie_p->ie_len == 0) {
                    return;
		}
                if (length < ie_p->ie_len + 2U) {
                    goto trunc;
                }
                ND_TCHECK2(*ptemp, ie_p->ie_len + 2U);

                if (fr_q933_print_ie_codeset[codeset] != NULL) {
                    ie_is_known = fr_q933_print_ie_codeset[codeset](ndo, ie_p, ptemp);
		}

                if (ndo->ndo_vflag >= 1 && !ie_is_known) {
                    print_unknown_data(ndo, ptemp+2, "\n\t", ie_p->ie_len);
		}

                /* do we want to see a hexdump of the IE ? */
                if (ndo->ndo_vflag> 1 && ie_is_known) {
                    print_unknown_data(ndo, ptemp+2, "\n\t  ", ie_p->ie_len);
		}

		length -= ie_p->ie_len + 2U;
		ptemp += ie_p->ie_len + 2U;
	}
        if (!ndo->ndo_vflag) {
            ND_PRINT((ndo, ", length %u", olen));
	}
	return;

trunc:
	ND_PRINT((ndo, "[|q.933]"));
}
