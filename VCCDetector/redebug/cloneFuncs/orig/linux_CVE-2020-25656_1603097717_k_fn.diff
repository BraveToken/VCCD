--- k_fn_OLD.c	2021-12-06 23:46:13.809754000 +0800
+++ k_fn_NEW.c	2021-12-06 23:46:13.809754000 +0800
@@ -4,8 +4,13 @@
 		return;
 
 	if ((unsigned)value < ARRAY_SIZE(func_table)) {
+		unsigned long flags;
+
+		spin_lock_irqsave(&func_buf_lock, flags);
 		if (func_table[value])
 			puts_queue(vc, func_table[value]);
+		spin_unlock_irqrestore(&func_buf_lock, flags);
+
 	} else
 		pr_err("k_fn called with value=%d\n", value);
 }
