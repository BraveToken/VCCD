--- frontend_changed_OLD.c	2021-12-06 23:30:32.869383900 +0800
+++ frontend_changed_NEW.c	2021-12-06 23:30:32.869383900 +0800
@@ -23,6 +23,11 @@
 		if (dev->state == XenbusStateConnected)
 			break;
 
+		/* Enforce precondition before potential leak point.
+		 * blkif_disconnect() is idempotent.
+		 */
+		blkif_disconnect(be->blkif);
+
 		err = connect_ring(be);
 		if (err)
 			break;
@@ -40,6 +45,7 @@
 			break;
 		/* fall through if not online */
 	case XenbusStateUnknown:
+		/* implies blkif_disconnect() via blkback_remove() */
 		device_unregister(&dev->dev);
 		break;
 
