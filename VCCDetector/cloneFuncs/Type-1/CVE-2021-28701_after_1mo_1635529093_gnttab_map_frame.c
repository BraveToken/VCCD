int gnttab_map_frame(struct domain *d, unsigned long idx, gfn_t gfn, mfn_t *mfn)
{
    int rc = 0;
    struct grant_table *gt = d->grant_table;
    bool status = false;

    grant_write_lock(gt);

    if ( evaluate_nospec(gt->gt_version == 2) && (idx & XENMAPIDX_grant_table_status) )
    {
        idx &= ~XENMAPIDX_grant_table_status;
        status = true;

        rc = gnttab_get_status_frame_mfn(d, idx, mfn);
    }
    else
        rc = gnttab_get_shared_frame_mfn(d, idx, mfn);

    if ( !rc && paging_mode_translate(d) )
    {
        gfn_t gfn = gnttab_get_frame_gfn(gt, status, idx);

        if ( !gfn_eq(gfn, INVALID_GFN) )
            rc = guest_physmap_remove_page(d, gfn, *mfn, 0);
    }

    if ( !rc )
    {
        /*
         * Make sure gnttab_unpopulate_status_frames() won't (successfully)
         * free the page until our caller has completed its operation.
         */
        if ( get_page(mfn_to_page(*mfn), d) )
            gnttab_set_frame_gfn(gt, status, idx, gfn);
        else
            rc = -EBUSY;
    }

    grant_write_unlock(gt);

    return rc;
}
