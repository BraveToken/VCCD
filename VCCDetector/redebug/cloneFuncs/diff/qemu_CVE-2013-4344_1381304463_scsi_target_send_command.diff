--- scsi_target_send_command_OLD.c	2021-12-06 23:56:02.757588600 +0800
+++ scsi_target_send_command_NEW.c	2021-12-06 23:56:02.757588600 +0800
@@ -14,8 +14,9 @@
         }
         break;
     case REQUEST_SENSE:
+        scsi_target_alloc_buf(&r->req, SCSI_SENSE_LEN);
         r->len = scsi_device_get_sense(r->req.dev, r->buf,
-                                       MIN(req->cmd.xfer, sizeof r->buf),
+                                       MIN(req->cmd.xfer, r->buf_len),
                                        (req->cmd.buf[1] & 1) == 0);
         if (r->req.dev->sense_is_ua) {
             scsi_device_unit_attention_reported(req->dev);
