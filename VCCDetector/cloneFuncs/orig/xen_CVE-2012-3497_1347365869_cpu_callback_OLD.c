static int cpu_callback(
    struct notifier_block *nfb, unsigned long action, void *hcpu)
{
    unsigned int cpu = (unsigned long)hcpu;

    switch ( action )
    {
    case CPU_UP_PREPARE: {
        if ( per_cpu(dstmem, cpu) == NULL )
        {
            struct page_info *p = alloc_domheap_pages(0, dstmem_order, 0);
            per_cpu(dstmem, cpu) = p ? page_to_virt(p) : NULL;
        }
        if ( per_cpu(workmem, cpu) == NULL )
        {
            struct page_info *p = alloc_domheap_pages(0, workmem_order, 0);
            per_cpu(workmem, cpu) = p ? page_to_virt(p) : NULL;
        }
        break;
    }
    case CPU_DEAD:
    case CPU_UP_CANCELED: {
        if ( per_cpu(dstmem, cpu) != NULL )
        {
            struct page_info *p = virt_to_page(per_cpu(dstmem, cpu));
            free_domheap_pages(p, dstmem_order);
            per_cpu(dstmem, cpu) = NULL;
        }
        if ( per_cpu(workmem, cpu) != NULL )
        {
            struct page_info *p = virt_to_page(per_cpu(workmem, cpu));
            free_domheap_pages(p, workmem_order);
            per_cpu(workmem, cpu) = NULL;
        }
        break;
    }
    default:
        break;
    }

    return NOTIFY_DONE;
}
